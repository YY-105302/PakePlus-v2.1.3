<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®æŸ¥è¯¢ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
            margin: 10px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        h1 {
            font-size: 22px;
            font-weight: 600;
        }
        
        .controls {
            padding: 15px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            flex-shrink: 0;
        }
        
        .search-box {
            flex: 1;
            min-width: 300px;
        }
        
        .search-box input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: #4d90fe;
            box-shadow: 0 0 0 2px rgba(77, 144, 254, 0.2);
        }
        
        .buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
        }
        
        .btn-primary {
            background-color: #4285f4;
            color: white;
        }
        
        .btn-success {
            background-color: #34a853;
            color: white;
        }
        
        .btn-danger {
            background-color: #ea4335;
            color: white;
        }
        
        .btn-warning {
            background-color: #fbbc05;
            color: white;
        }
        
        button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .column-selector {
            padding: 10px 15px;
            background-color: #f1f3f4;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .column-option {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
        }
        
        .column-option input {
            margin: 0;
        }
        
        .table-container {
            flex: 1;
            overflow: auto;
            position: relative;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: 11px;
            min-width: 100%;
        }
        
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            background-color: #f1f3f4;
            padding: 8px 10px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
            position: relative;
            user-select: none;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 150px; /* é»˜è®¤åˆ—å®½ */
        }
        
        th:hover {
            background-color: #e8eaed;
        }
        
        .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: #ccc;
            cursor: col-resize;
        }
        
        .resize-handle:hover {
            background-color: #4285f4;
        }
        
        td {
            padding: 6px 8px;
            border-bottom: 1px solid #dee2e6;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .status-bar {
            padding: 8px 15px;
            background-color: #e9ecef;
            font-size: 12px;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            font-size: 14px;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 150px;
            font-size: 14px;
            color: #6c757d;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4285f4;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .highlight {
            background-color: #fff3cd;
        }
        
        .virtual-scroll-placeholder {
            height: 1px;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(20px);
            opacity: 0;
        }
        
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .notification.success {
            background-color: #34a853;
        }
        
        .notification.error {
            background-color: #ea4335;
        }
        
        .notification.info {
            background-color: #4285f4;
        }
        
        .data-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .storage-info {
            font-size: 11px;
            color: #666;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .db-status {
            font-size: 11px;
            color: #666;
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>æ•°æ®æŸ¥è¯¢ç³»ç»Ÿ</h1>
            <div class="status-bar">
                <div>æ•°æ®é‡: <span id="dataCount">0</span> è¡Œ</div>
                <div>å½“å‰æ˜¾ç¤º: <span id="displayCount">0</span> è¡Œ</div>
            </div>
        </header>
        
        <div class="controls">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="è¾“å…¥å…³é”®è¯è¿›è¡ŒæŸ¥è¯¢...">
            </div>
            <div class="buttons">
                <button id="importBtn" class="btn-primary">
                    <i>ğŸ“</i> å¯¼å…¥Excel
                </button>
                <button id="exportBtn" class="btn-success">
                    <i>ğŸ“Š</i> å¯¼å‡ºExcel
                </button>
                <button id="clearBtn" class="btn-danger">
                    <i>ğŸ—‘ï¸</i> æ¸…é™¤æ•°æ®
                </button>
                <div class="data-actions">
                    <button id="exportDBBtn" class="btn-warning">
                        <i>ğŸ’¾</i> å¯¼å‡ºæ•°æ®åº“
                    </button>
                    <button id="importDBBtn" class="btn-primary">
                        <i>ğŸ“‚</i> å¯¼å…¥æ•°æ®åº“
                    </button>
                    <div class="storage-info" id="storageInfo">IndexedDB</div>
                    <div class="db-status" id="dbStatus">æœªè¿æ¥</div>
                </div>
            </div>
        </div>
        
        <div class="column-selector" id="columnSelector">
            <!-- åˆ—é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        
        <div class="table-container" id="tableContainer">
            <table id="dataTable">
                <thead id="tableHeader">
                    <!-- è¡¨å¤´å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="20" class="no-data">æš‚æ— æ•°æ®ï¼Œè¯·å¯¼å…¥æ•°æ®æ–‡ä»¶</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- å¯¼å‡ºæ•°æ®åº“æ¨¡æ€æ¡† -->
    <div id="exportDBModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">å¯¼å‡ºæ•°æ®åº“</div>
                <button class="close-button" id="closeExportModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="exportFileName">æ–‡ä»¶å</label>
                    <input type="text" id="exportFileName" value="æ•°æ®æŸ¥è¯¢ç³»ç»Ÿå¤‡ä»½" placeholder="è¾“å…¥æ–‡ä»¶å">
                </div>
                <div class="form-group">
                    <label for="includeSettings">åŒ…å«è®¾ç½®</label>
                    <select id="includeSettings">
                        <option value="yes">æ˜¯</option>
                        <option value="no">å¦</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¯¼å‡ºå†…å®¹</label>
                    <div>
                        <input type="checkbox" id="exportTableData" checked>
                        <label for="exportTableData">è¡¨æ ¼æ•°æ®</label>
                    </div>
                    <div>
                        <input type="checkbox" id="exportColumnSettings" checked>
                        <label for="exportColumnSettings">åˆ—è®¾ç½®</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelExport" class="btn-danger">å–æ¶ˆ</button>
                <button id="confirmExport" class="btn-success">å¯¼å‡º</button>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥æ•°æ®åº“æ¨¡æ€æ¡† -->
    <div id="importDBModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">å¯¼å…¥æ•°æ®åº“</div>
                <button class="close-button" id="closeImportModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="importFile">é€‰æ‹©å¤‡ä»½æ–‡ä»¶</label>
                    <input type="file" id="importFile" accept=".json">
                </div>
                <div class="form-group">
                    <label for="importOptions">å¯¼å…¥é€‰é¡¹</label>
                    <select id="importOptions">
                        <option value="replace">æ›¿æ¢å½“å‰æ•°æ®</option>
                        <option value="merge">åˆå¹¶æ•°æ®</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å¯¼å…¥å†…å®¹</label>
                    <div>
                        <input type="checkbox" id="importTableData" checked>
                        <label for="importTableData">è¡¨æ ¼æ•°æ®</label>
                    </div>
                    <div>
                        <input type="checkbox" id="importColumnSettings" checked>
                        <label for="importColumnSettings">åˆ—è®¾ç½®</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelImport" class="btn-danger">å–æ¶ˆ</button>
                <button id="confirmImport" class="btn-success">å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // å…¨å±€å˜é‡
        let allData = [];
        let filteredData = [];
        let isResizing = false;
        let currentResizeColumn = null;
        let startX = 0;
        let startWidth = 0;
        let columnVisibility = {};
        let columnWidths = {};
        let rowHeight = 28; // é¢„ä¼°è¡Œé«˜
        let visibleRowCount = 0;
        let scrollTop = 0;
        let columnOrder = [
            'index', 'org', 'assembly', 'assemblyDesc', 'materialIndex', 'process', 
            'component', 'componentName', 'componentDesc', 'unit', 'unitUsage', 'yield', 
            'supplyType', 'supplySubstore', 'referenceIndicator', 'referenceDesc', 
            'alternativeCode', 'alternativeDesc', 'alternativeUsage', 'alternativePriority'
        ];
        
        const columnTitles = {
            'index': 'åºå·',
            'org': 'ç»„ç»‡',
            'assembly': 'è£…é…ä»¶',
            'assemblyDesc': 'è£…é…ä»¶æè¿°',
            'materialIndex': 'ç‰©æ–™åºå·',
            'process': 'å·¥åº',
            'component': 'ç»„ä»¶',
            'componentName': 'ç»„ä»¶åç§°',
            'componentDesc': 'ç»„ä»¶æè¿°',
            'unit': 'å•ä½',
            'unitUsage': 'å•ä½ç”¨é‡',
            'yield': 'äº§å‡ºç‡',
            'supplyType': 'ä¾›åº”ç±»å‹',
            'supplySubstore': 'ä¾›åº”å­åº“',
            'referenceIndicator': 'å‚è€ƒæŒ‡ç¤ºç¬¦',
            'referenceDesc': 'å‚è€ƒæŒ‡ç¤ºç¬¦è¯´æ˜',
            'alternativeCode': 'æ›¿ä»£æ–™ç¼–ç ',
            'alternativeDesc': 'æ›¿ä»£æ–™æè¿°',
            'alternativeUsage': 'æ›¿ä»£æ–™ç”¨é‡',
            'alternativePriority': 'æ›¿ä»£æ–™ä¼˜å…ˆçº§'
        };

        // IndexedDBç›¸å…³å˜é‡
        let db = null;
        const DB_NAME = 'DataQuerySystemDB';
        const DB_VERSION = 1;
        const TABLE_DATA_STORE = 'tableData';
        const SETTINGS_STORE = 'settings';

        // DOMå…ƒç´ 
        const tableBody = document.getElementById('tableBody');
        const tableHeader = document.getElementById('tableHeader');
        const columnSelector = document.getElementById('columnSelector');
        const searchInput = document.getElementById('searchInput');
        const importBtn = document.getElementById('importBtn');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const exportDBBtn = document.getElementById('exportDBBtn');
        const importDBBtn = document.getElementById('importDBBtn');
        const dataCount = document.getElementById('dataCount');
        const displayCount = document.getElementById('displayCount');
        const tableContainer = document.getElementById('tableContainer');
        const notification = document.getElementById('notification');
        const storageInfo = document.getElementById('storageInfo');
        const dbStatus = document.getElementById('dbStatus');
        
        // æ¨¡æ€æ¡†å…ƒç´ 
        const exportDBModal = document.getElementById('exportDBModal');
        const importDBModal = document.getElementById('importDBModal');
        const closeExportModal = document.getElementById('closeExportModal');
        const closeImportModal = document.getElementById('closeImportModal');
        const cancelExport = document.getElementById('cancelExport');
        const cancelImport = document.getElementById('cancelImport');
        const confirmExport = document.getElementById('confirmExport');
        const confirmImport = document.getElementById('confirmImport');
        const exportFileName = document.getElementById('exportFileName');
        const includeSettings = document.getElementById('includeSettings');
        const exportTableData = document.getElementById('exportTableData');
        const exportColumnSettings = document.getElementById('exportColumnSettings');
        const importFile = document.getElementById('importFile');
        const importOptions = document.getElementById('importOptions');
        const importTableData = document.getElementById('importTableData');
        const importColumnSettings = document.getElementById('importColumnSettings');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // åˆå§‹åŒ–åˆ—å¯è§æ€§å’Œåˆ—å®½
            columnOrder.forEach(col => {
                columnVisibility[col] = true;
                columnWidths[col] = 150; // é»˜è®¤åˆ—å®½
            });
            
            // åˆå§‹åŒ–IndexedDB
            await initDB();
            
            // å°è¯•ä»IndexedDBåŠ è½½æ•°æ®
            await loadDataFromDB();
            
            // ç»‘å®šäº‹ä»¶
            searchInput.addEventListener('input', handleSearch);
            importBtn.addEventListener('click', handleImport);
            exportBtn.addEventListener('click', handleExport);
            clearBtn.addEventListener('click', handleClear);
            exportDBBtn.addEventListener('click', showExportModal);
            importDBBtn.addEventListener('click', showImportModal);
            tableContainer.addEventListener('scroll', handleScroll);
            
            // æ¨¡æ€æ¡†äº‹ä»¶
            closeExportModal.addEventListener('click', hideExportModal);
            closeImportModal.addEventListener('click', hideImportModal);
            cancelExport.addEventListener('click', hideExportModal);
            cancelImport.addEventListener('click', hideImportModal);
            confirmExport.addEventListener('click', handleExportDB);
            confirmImport.addEventListener('click', handleImportDB);
            
            // åˆå§‹åŒ–åˆ—å®½è°ƒæ•´
            initColumnResize();
            
            // ç”Ÿæˆåˆ—é€‰æ‹©å™¨
            generateColumnSelector();
            
            // åˆå§‹æ¸²æŸ“è¡¨å¤´
            renderTableHeader();
            
            // è®¡ç®—å¯è§è¡Œæ•°
            calculateVisibleRows();
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', calculateVisibleRows);
        });

        // åˆå§‹åŒ–IndexedDB
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = function(event) {
                    console.error('æ‰“å¼€æ•°æ®åº“å¤±è´¥:', event.target.error);
                    dbStatus.textContent = 'è¿æ¥å¤±è´¥';
                    showNotification('æ•°æ®åº“è¿æ¥å¤±è´¥', 'error');
                    reject(event.target.error);
                };
                
                request.onsuccess = function(event) {
                    db = event.target.result;
                    console.log('æ•°æ®åº“è¿æ¥æˆåŠŸ');
                    dbStatus.textContent = 'å·²è¿æ¥';
                    resolve(db);
                };
                
                request.onupgradeneeded = function(event) {
                    console.log('æ•°æ®åº“å‡çº§/åˆå§‹åŒ–');
                    db = event.target.result;
                    
                    // åˆ›å»ºè¡¨æ•°æ®å­˜å‚¨
                    if (!db.objectStoreNames.contains(TABLE_DATA_STORE)) {
                        const tableDataStore = db.createObjectStore(TABLE_DATA_STORE, { keyPath: 'id', autoIncrement: true });
                        tableDataStore.createIndex('data', 'data', { unique: false });
                    }
                    
                    // åˆ›å»ºè®¾ç½®å­˜å‚¨
                    if (!db.objectStoreNames.contains(SETTINGS_STORE)) {
                        const settingsStore = db.createObjectStore(SETTINGS_STORE, { keyPath: 'name' });
                    }
                };
            });
        }

        // ä»IndexedDBåŠ è½½æ•°æ®
        async function loadDataFromDB() {
            if (!db) {
                console.error('æ•°æ®åº“æœªåˆå§‹åŒ–');
                return;
            }
            
            try {
                // åŠ è½½è¡¨æ•°æ®
                const tableData = await getDataFromStore(TABLE_DATA_STORE, 'all');
                if (tableData && tableData.length > 0) {
                    allData = tableData[0].data || [];
                    filteredData = [...allData];
                    updateDataCount();
                    renderTableBody();
                    showNotification('æ•°æ®å·²ä»æ•°æ®åº“åŠ è½½', 'success');
                    console.log('æ•°æ®å·²ä»æ•°æ®åº“åŠ è½½');
                } else {
                    generateSampleData();
                }
                
                // åŠ è½½åˆ—å®½è®¾ç½®
                const columnWidthsData = await getDataFromStore(SETTINGS_STORE, 'columnWidths');
                if (columnWidthsData) {
                    Object.assign(columnWidths, columnWidthsData.value);
                }
                
                // åŠ è½½åˆ—å¯è§æ€§è®¾ç½®
                const columnVisibilityData = await getDataFromStore(SETTINGS_STORE, 'columnVisibility');
                if (columnVisibilityData) {
                    Object.assign(columnVisibility, columnVisibilityData.value);
                    generateColumnSelector();
                }
            } catch (error) {
                console.error('ä»æ•°æ®åº“åŠ è½½æ•°æ®å¤±è´¥:', error);
                generateSampleData();
            }
        }

        // ä»å­˜å‚¨ä¸­è·å–æ•°æ®
        function getDataFromStore(storeName, key) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('æ•°æ®åº“æœªåˆå§‹åŒ–'));
                    return;
                }
                
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                
                let request;
                if (key === 'all') {
                    request = store.getAll();
                } else {
                    request = store.get(key);
                }
                
                request.onsuccess = function() {
                    resolve(request.result);
                };
                
                request.onerror = function() {
                    reject(request.error);
                };
            });
        }

        // ä¿å­˜æ•°æ®åˆ°IndexedDB
        async function saveDataToDB() {
            if (!db) {
                console.error('æ•°æ®åº“æœªåˆå§‹åŒ–');
                return false;
            }
            
            try {
                // ä¿å­˜è¡¨æ•°æ®
                await saveDataToStore(TABLE_DATA_STORE, { id: 1, data: allData });
                
                // ä¿å­˜åˆ—å®½è®¾ç½®
                await saveDataToStore(SETTINGS_STORE, { name: 'columnWidths', value: columnWidths });
                
                // ä¿å­˜åˆ—å¯è§æ€§è®¾ç½®
                await saveDataToStore(SETTINGS_STORE, { name: 'columnVisibility', value: columnVisibility });
                
                showNotification('æ•°æ®å·²ä¿å­˜åˆ°æ•°æ®åº“', 'success');
                console.log('æ•°æ®å·²ä¿å­˜åˆ°æ•°æ®åº“');
                return true;
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®åˆ°æ•°æ®åº“å¤±è´¥:', error);
                showNotification('ä¿å­˜æ•°æ®å¤±è´¥', 'error');
                return false;
            }
        }

        // ä¿å­˜æ•°æ®åˆ°å­˜å‚¨
        function saveDataToStore(storeName, data) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('æ•°æ®åº“æœªåˆå§‹åŒ–'));
                    return;
                }
                
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                const request = store.put(data);
                
                request.onsuccess = function() {
                    resolve(request.result);
                };
                
                request.onerror = function() {
                    reject(request.error);
                };
            });
        }

        // æ¸…é™¤æ•°æ®åº“ä¸­çš„æ•°æ®
        async function clearDB() {
            if (!db) {
                console.error('æ•°æ®åº“æœªåˆå§‹åŒ–');
                return false;
            }
            
            try {
                // æ¸…ç©ºè¡¨æ•°æ®
                await clearStore(TABLE_DATA_STORE);
                
                // æ¸…ç©ºè®¾ç½®
                await clearStore(SETTINGS_STORE);
                
                showNotification('æ•°æ®åº“å·²æ¸…ç©º', 'success');
                console.log('æ•°æ®åº“å·²æ¸…ç©º');
                return true;
            } catch (error) {
                console.error('æ¸…ç©ºæ•°æ®åº“å¤±è´¥:', error);
                showNotification('æ¸…ç©ºæ•°æ®åº“å¤±è´¥', 'error');
                return false;
            }
        }

        // æ¸…ç©ºå­˜å‚¨
        function clearStore(storeName) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('æ•°æ®åº“æœªåˆå§‹åŒ–'));
                    return;
                }
                
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                const request = store.clear();
                
                request.onsuccess = function() {
                    resolve();
                };
                
                request.onerror = function() {
                    reject(request.error);
                };
            });
        }

        // æ˜¾ç¤ºå¯¼å‡ºæ•°æ®åº“æ¨¡æ€æ¡†
        function showExportModal() {
            exportDBModal.style.display = 'flex';
        }

        // éšè—å¯¼å‡ºæ•°æ®åº“æ¨¡æ€æ¡†
        function hideExportModal() {
            exportDBModal.style.display = 'none';
        }

        // æ˜¾ç¤ºå¯¼å…¥æ•°æ®åº“æ¨¡æ€æ¡†
        function showImportModal() {
            importDBModal.style.display = 'flex';
        }

        // éšè—å¯¼å…¥æ•°æ®åº“æ¨¡æ€æ¡†
        function hideImportModal() {
            importDBModal.style.display = 'none';
        }

        // å¤„ç†å¯¼å‡ºæ•°æ®åº“
        async function handleExportDB() {
            try {
                const fileName = exportFileName.value || 'æ•°æ®æŸ¥è¯¢ç³»ç»Ÿå¤‡ä»½';
                const includeTableData = exportTableData.checked;
                const includeColumnSettings = exportColumnSettings.checked;
                
                // å‡†å¤‡å¯¼å‡ºçš„æ•°æ®
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    tableData: includeTableData ? allData : null,
                    columnSettings: includeColumnSettings ? {
                        columnWidths,
                        columnVisibility
                    } : null
                };
                
                // åˆ›å»ºJSONæ–‡ä»¶
                const jsonData = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const a = document.createElement('a');
                a.href = url;
                a.download = `${fileName}.json`;
                document.body.appendChild(a);
                a.click();
                
                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 0);
                
                hideExportModal();
                showNotification('æ•°æ®åº“å·²æˆåŠŸå¯¼å‡º', 'success');
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®åº“å¤±è´¥:', error);
                showNotification('å¯¼å‡ºæ•°æ®åº“å¤±è´¥', 'error');
            }
        }

        // å¤„ç†å¯¼å…¥æ•°æ®åº“
        async function handleImportDB() {
            try {
                const file = importFile.files[0];
                if (!file) {
                    showNotification('è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶', 'error');
                    return;
                }
                
                const importOption = importOptions.value;
                const importTableDataFlag = importTableData.checked;
                const importColumnSettingsFlag = importColumnSettings.checked;
                
                // è¯»å–æ–‡ä»¶
                const reader = new FileReader();
                
                reader.onload = async function(e) {
                    try {
                        const jsonData = e.target.result;
                        const importData = JSON.parse(jsonData);
                        
                        // éªŒè¯æ•°æ®æ ¼å¼
                        if (!importData.version) {
                            throw new Error('æ— æ•ˆçš„å¤‡ä»½æ–‡ä»¶æ ¼å¼');
                        }
                        
                        // å¯¼å…¥è¡¨æ ¼æ•°æ®
                        if (importTableDataFlag && importData.tableData) {
                            if (importOption === 'replace') {
                                allData = importData.tableData;
                            } else if (importOption === 'merge') {
                                // åˆå¹¶æ•°æ®ï¼Œé¿å…é‡å¤
                                const existingIds = new Set(allData.map(item => item.id));
                                const newData = importData.tableData.filter(item => !existingIds.has(item.id));
                                allData = [...allData, ...newData];
                            }
                            filteredData = [...allData];
                            updateDataCount();
                            renderTableBody();
                        }
                        
                        // å¯¼å…¥åˆ—è®¾ç½®
                        if (importColumnSettingsFlag && importData.columnSettings) {
                            if (importData.columnSettings.columnWidths) {
                                Object.assign(columnWidths, importData.columnSettings.columnWidths);
                            }
                            if (importData.columnSettings.columnVisibility) {
                                Object.assign(columnVisibility, importData.columnSettings.columnVisibility);
                                generateColumnSelector();
                            }
                            renderTableHeader();
                        }
                        
                        // ä¿å­˜åˆ°IndexedDB
                        await saveDataToDB();
                        
                        hideImportModal();
                        showNotification('æ•°æ®åº“å·²æˆåŠŸå¯¼å…¥', 'success');
                    } catch (error) {
                        console.error('å¯¼å…¥æ•°æ®åº“å¤±è´¥:', error);
                        showNotification('å¯¼å…¥æ•°æ®åº“å¤±è´¥: ' + error.message, 'error');
                    }
                };
                
                reader.readAsText(file);
            } catch (error) {
                console.error('å¯¼å…¥æ•°æ®åº“å¤±è´¥:', error);
                showNotification('å¯¼å…¥æ•°æ®åº“å¤±è´¥', 'error');
            }
        }

        // ç”Ÿæˆåˆ—é€‰æ‹©å™¨
        function generateColumnSelector() {
            columnSelector.innerHTML = '';
            columnOrder.forEach(col => {
                const option = document.createElement('div');
                option.className = 'column-option';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `col-${col}`;
                checkbox.checked = columnVisibility[col];
                checkbox.addEventListener('change', function() {
                    columnVisibility[col] = this.checked;
                    renderTableHeader();
                    renderTableBody();
                    saveDataToDB();
                });
                
                const label = document.createElement('label');
                label.htmlFor = `col-${col}`;
                label.textContent = columnTitles[col];
                
                option.appendChild(checkbox);
                option.appendChild(label);
                columnSelector.appendChild(option);
            });
        }

        // ç”Ÿæˆç¤ºä¾‹æ•°æ®
        function generateSampleData() {
            // åˆ›å»ºç¤ºä¾‹æ•°æ®
            const organizations = ['ç»„ç»‡A', 'ç»„ç»‡B', 'ç»„ç»‡C'];
            const assemblies = ['è£…é…ä»¶A', 'è£…é…ä»¶B', 'è£…é…ä»¶C'];
            const components = ['ç»„ä»¶A', 'ç»„ä»¶B', 'ç»„ä»¶C', 'ç»„ä»¶D'];
            const units = ['ä¸ª', 'åƒå…‹', 'ç±³', 'å¥—'];
            const supplyTypes = ['å†…éƒ¨ä¾›åº”', 'å¤–éƒ¨é‡‡è´­'];
            
            // ç”Ÿæˆ100è¡Œç¤ºä¾‹æ•°æ®ï¼ˆå®é™…ä½¿ç”¨ä¸­åº”è¯¥ä»æ–‡ä»¶å¯¼å…¥ï¼‰
            const sampleData = [];
            for (let i = 1; i <= 100; i++) {
                sampleData.push({
                    id: i,
                    index: i,
                    org: organizations[Math.floor(Math.random() * organizations.length)],
                    assembly: assemblies[Math.floor(Math.random() * assemblies.length)],
                    assemblyDesc: `è£…é…ä»¶${i}æè¿°`,
                    materialIndex: `MAT${i.toString().padStart(6, '0')}`,
                    process: `å·¥åº${(i % 5) + 1}`,
                    component: components[Math.floor(Math.random() * components.length)],
                    componentName: `ç»„ä»¶${i}åç§°`,
                    componentDesc: `ç»„ä»¶${i}æè¿°`,
                    unit: units[Math.floor(Math.random() * units.length)],
                    unitUsage: (Math.random() * 10).toFixed(2),
                    yield: (Math.random() * 100).toFixed(2) + '%',
                    supplyType: supplyTypes[Math.floor(Math.random() * supplyTypes.length)],
                    supplySubstore: `å­åº“${(i % 3) + 1}`,
                    referenceIndicator: `REF${i}`,
                    referenceDesc: `å‚è€ƒæŒ‡ç¤ºç¬¦${i}è¯´æ˜`,
                    alternativeCode: `ALT${i}`,
                    alternativeDesc: `æ›¿ä»£æ–™${i}æè¿°`,
                    alternativeUsage: (Math.random() * 5).toFixed(2),
                    alternativePriority: (i % 5) + 1
                });
            }
            
            allData = sampleData;
            filteredData = [...allData];
            updateDataCount();
            renderTableBody();
        }

        // å¤„ç†æœç´¢
        function handleSearch() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                filteredData = [...allData];
            } else {
                filteredData = allData.filter(row => {
                    return Object.values(row).some(value => 
                        String(value).toLowerCase().includes(searchTerm)
                    );
                });
            }
            
            renderTableBody();
        }

        // æ¸²æŸ“è¡¨å¤´
        function renderTableHeader() {
            // æ¸…ç©ºè¡¨å¤´
            tableHeader.innerHTML = '';
            
            // åˆ›å»ºè¡¨å¤´è¡Œ
            const tr = document.createElement('tr');
            
            // æ·»åŠ å¯è§çš„åˆ—
            columnOrder.forEach(col => {
                if (columnVisibility[col]) {
                    const th = document.createElement('th');
                    th.textContent = columnTitles[col];
                    th.setAttribute('data-field', col);
                    th.style.width = columnWidths[col] + 'px';
                    
                    const resizeHandle = document.createElement('div');
                    resizeHandle.className = 'resize-handle';
                    
                    th.appendChild(resizeHandle);
                    tr.appendChild(th);
                }
            });
            
            tableHeader.appendChild(tr);
            
            // é‡æ–°åˆå§‹åŒ–åˆ—å®½è°ƒæ•´
            initColumnResize();
        }

        // æ¸²æŸ“è¡¨æ ¼ä¸»ä½“
        function renderTableBody() {
            if (filteredData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="20" class="no-data">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ•°æ®</td></tr>';
                updateDisplayCount();
                return;
            }
            
            // è®¡ç®—å¯è§åŒºåŸŸçš„æ•°æ®
            const startIndex = Math.floor(scrollTop / rowHeight);
            const endIndex = Math.min(startIndex + visibleRowCount + 5, filteredData.length);
            
            // æ¸…ç©ºè¡¨æ ¼ä¸»ä½“
            tableBody.innerHTML = '';
            
            // æ·»åŠ ä¸Šæ–¹å ä½ç¬¦
            const topPlaceholder = document.createElement('tr');
            topPlaceholder.innerHTML = `<td colspan="${Object.values(columnVisibility).filter(v => v).length}">
                <div class="virtual-scroll-placeholder" style="height: ${startIndex * rowHeight}px"></div>
            </td>`;
            tableBody.appendChild(topPlaceholder);
            
            // æ¸²æŸ“å¯è§åŒºåŸŸçš„æ•°æ®è¡Œ
            for (let i = startIndex; i < endIndex; i++) {
                const row = filteredData[i];
                const tr = document.createElement('tr');
                
                // ä¸ºæ¯ä¸ªå¯è§å­—æ®µåˆ›å»ºå•å…ƒæ ¼
                columnOrder.forEach(col => {
                    if (columnVisibility[col]) {
                        const td = document.createElement('td');
                        td.textContent = row[col];
                        td.title = row[col]; // æ·»åŠ titleä»¥ä¾¿é¼ æ ‡æ‚¬åœæ—¶æ˜¾ç¤ºå®Œæ•´å†…å®¹
                        tr.appendChild(td);
                    }
                });
                
                tableBody.appendChild(tr);
            }
            
            // æ·»åŠ ä¸‹æ–¹å ä½ç¬¦
            const bottomPlaceholder = document.createElement('tr');
            bottomPlaceholder.innerHTML = `<td colspan="${Object.values(columnVisibility).filter(v => v).length}">
                <div class="virtual-scroll-placeholder" style="height: ${(filteredData.length - endIndex) * rowHeight}px"></div>
            </td>`;
            tableBody.appendChild(bottomPlaceholder);
            
            updateDisplayCount();
        }

        // å¤„ç†æ»šåŠ¨
        function handleScroll() {
            scrollTop = tableContainer.scrollTop;
            renderTableBody();
        }

        // è®¡ç®—å¯è§è¡Œæ•°
        function calculateVisibleRows() {
            const containerHeight = tableContainer.clientHeight;
            const headerHeight = tableHeader.offsetHeight;
            visibleRowCount = Math.ceil((containerHeight - headerHeight) / rowHeight);
            renderTableBody();
        }

        // æ›´æ–°æ•°æ®è®¡æ•°
        function updateDataCount() {
            dataCount.textContent = allData.length.toLocaleString();
        }

        // æ›´æ–°æ˜¾ç¤ºè®¡æ•°
        function updateDisplayCount() {
            displayCount.textContent = filteredData.length.toLocaleString();
        }

        // åˆå§‹åŒ–åˆ—å®½è°ƒæ•´
        function initColumnResize() {
            const headers = document.querySelectorAll('th');
            
            headers.forEach(header => {
                const resizeHandle = header.querySelector('.resize-handle');
                
                resizeHandle.addEventListener('mousedown', function(e) {
                    isResizing = true;
                    currentResizeColumn = header;
                    startX = e.pageX;
                    startWidth = header.offsetWidth;
                    
                    document.addEventListener('mousemove', handleResize);
                    document.addEventListener('mouseup', stopResize);
                    
                    e.preventDefault();
                });
            });
        }

        // å¤„ç†åˆ—å®½è°ƒæ•´
        function handleResize(e) {
            if (!isResizing) return;
            
            const width = startWidth + (e.pageX - startX);
            if (width > 30) { // æœ€å°å®½åº¦é™åˆ¶
                currentResizeColumn.style.width = width + 'px';
                
                // æ›´æ–°åˆ—å®½è®¾ç½®
                const field = currentResizeColumn.getAttribute('data-field');
                columnWidths[field] = width;
                
                // æ›´æ–°è¡¨æ ¼å¸ƒå±€
                const table = document.getElementById('dataTable');
                table.style.tableLayout = 'fixed';
            }
        }

        // åœæ­¢åˆ—å®½è°ƒæ•´
        function stopResize() {
            isResizing = false;
            currentResizeColumn = null;
            document.removeEventListener('mousemove', handleResize);
            document.removeEventListener('mouseup', stopResize);
            
            // ä¿å­˜åˆ—å®½è®¾ç½®åˆ°æ•°æ®åº“
            saveDataToDB();
        }

        // å¤„ç†å¯¼å…¥Excel
        function handleImport() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.xlsx, .xls';
            
            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                tableBody.innerHTML = '<tr><td colspan="20" class="loading"><div class="spinner"></div>æ­£åœ¨å¯¼å…¥æ•°æ®ï¼Œè¯·ç¨å€™...</td></tr>';
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        
                        // è·å–ç¬¬ä¸€ä¸ªå·¥ä½œè¡¨
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        
                        // å°†å·¥ä½œè¡¨è½¬æ¢ä¸ºJSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        // å¤„ç†æ•°æ®ï¼ˆå‡è®¾ç¬¬ä¸€è¡Œæ˜¯æ ‡é¢˜ï¼‰
                        if (jsonData.length > 1) {
                            const headers = jsonData[0];
                            allData = [];
                            
                            for (let i = 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (row.length === 0) continue;
                                
                                const rowData = {};
                                headers.forEach((header, index) => {
                                    // å°†ä¸­æ–‡æ ‡é¢˜æ˜ å°„åˆ°å­—æ®µå
                                    const fieldMap = {
                                        'åºå·': 'index',
                                        'ç»„ç»‡': 'org',
                                        'è£…é…ä»¶': 'assembly',
                                        'è£…é…ä»¶æè¿°': 'assemblyDesc',
                                        'ç‰©æ–™åºå·': 'materialIndex',
                                        'å·¥åº': 'process',
                                        'ç»„ä»¶': 'component',
                                        'ç»„ä»¶åç§°': 'componentName',
                                        'ç»„ä»¶æè¿°': 'componentDesc',
                                        'å•ä½': 'unit',
                                        'å•ä½ç”¨é‡': 'unitUsage',
                                        'äº§å‡ºç‡': 'yield',
                                        'ä¾›åº”ç±»å‹': 'supplyType',
                                        'ä¾›åº”å­åº“': 'supplySubstore',
                                        'å‚è€ƒæŒ‡ç¤ºç¬¦': 'referenceIndicator',
                                        'å‚è€ƒæŒ‡ç¤ºç¬¦è¯´æ˜': 'referenceDesc',
                                        'æ›¿ä»£æ–™ç¼–ç ': 'alternativeCode',
                                        'æ›¿ä»£æ–™æè¿°': 'alternativeDesc',
                                        'æ›¿ä»£æ–™ç”¨é‡': 'alternativeUsage',
                                        'æ›¿ä»£æ–™ä¼˜å…ˆçº§': 'alternativePriority'
                                    };
                                    
                                    const fieldName = fieldMap[header] || header;
                                    rowData[fieldName] = row[index] || '';
                                });
                                
                                // æ·»åŠ å”¯ä¸€ID
                                rowData.id = i;
                                
                                allData.push(rowData);
                            }
                            
                            filteredData = [...allData];
                            updateDataCount();
                            renderTableBody();
                            
                            // ä¿å­˜åˆ°æ•°æ®åº“
                            if (saveDataToDB()) {
                                showNotification(`æˆåŠŸå¯¼å…¥ ${allData.length} æ¡æ•°æ®`, 'success');
                            } else {
                                showNotification(`æˆåŠŸå¯¼å…¥ ${allData.length} æ¡æ•°æ®ï¼Œä½†ä¿å­˜å¤±è´¥`, 'error');
                            }
                        }
                    } catch (error) {
                        console.error('å¯¼å…¥å¤±è´¥:', error);
                        showNotification('å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼', 'error');
                    }
                };
                
                reader.readAsArrayBuffer(file);
            });
            
            fileInput.click();
        }

        // å¤„ç†å¯¼å‡ºExcel
        function handleExport() {
            if (allData.length === 0) {
                showNotification('æ²¡æœ‰æ•°æ®å¯å¯¼å‡º', 'error');
                return;
            }
            
            try {
                // åˆ›å»ºå·¥ä½œç°¿
                const workbook = XLSX.utils.book_new();
                
                // å‡†å¤‡æ•°æ®
                const headers = [
                    'åºå·', 'ç»„ç»‡', 'è£…é…ä»¶', 'è£…é…ä»¶æè¿°', 'ç‰©æ–™åºå·', 'å·¥åº', 
                    'ç»„ä»¶', 'ç»„ä»¶åç§°', 'ç»„ä»¶æè¿°', 'å•ä½', 'å•ä½ç”¨é‡', 'äº§å‡ºç‡', 
                    'ä¾›åº”ç±»å‹', 'ä¾›åº”å­åº“', 'å‚è€ƒæŒ‡ç¤ºç¬¦', 'å‚è€ƒæŒ‡ç¤ºç¬¦è¯´æ˜', 
                    'æ›¿ä»£æ–™ç¼–ç ', 'æ›¿ä»£æ–™æè¿°', 'æ›¿ä»£æ–™ç”¨é‡', 'æ›¿ä»£æ–™ä¼˜å…ˆçº§'
                ];
                
                const data = [headers];
                
                allData.forEach(row => {
                    const rowData = [
                        row.index,
                        row.org,
                        row.assembly,
                        row.assemblyDesc,
                        row.materialIndex,
                        row.process,
                        row.component,
                        row.componentName,
                        row.componentDesc,
                        row.unit,
                        row.unitUsage,
                        row.yield,
                        row.supplyType,
                        row.supplySubstore,
                        row.referenceIndicator,
                        row.referenceDesc,
                        row.alternativeCode,
                        row.alternativeDesc,
                        row.alternativeUsage,
                        row.alternativePriority
                    ];
                    
                    data.push(rowData);
                });
                
                // åˆ›å»ºå·¥ä½œè¡¨
                const worksheet = XLSX.utils.aoa_to_sheet(data);
                
                // å°†å·¥ä½œè¡¨æ·»åŠ åˆ°å·¥ä½œç°¿
                XLSX.utils.book_append_sheet(workbook, worksheet, 'æ•°æ®');
                
                // å¯¼å‡ºæ–‡ä»¶
                XLSX.writeFile(workbook, 'æ•°æ®å¯¼å‡º.xlsx');
                
                showNotification(`æˆåŠŸå¯¼å‡º ${allData.length} æ¡æ•°æ®`, 'success');
            } catch (error) {
                console.error('å¯¼å‡ºå¤±è´¥:', error);
                showNotification('å¯¼å‡ºå¤±è´¥', 'error');
            }
        }

        // å¤„ç†æ¸…é™¤æ•°æ®
        async function handleClear() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                allData = [];
                filteredData = [];
                searchInput.value = '';
                updateDataCount();
                renderTableBody();
                
                // ä»æ•°æ®åº“æ¸…é™¤æ•°æ®
                await clearDB();
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>